<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>ğŸ€„ éº»å°‡ç±Œç¢¼</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;900&family=Oswald:wght@500;700&display=swap" rel="stylesheet">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â˜…  åœ¨ä¸‹æ–¹å¡«å…¥ä½ çš„ Firebase è¨­å®š  â˜…
     è«‹å‰å¾€ https://console.firebase.google.com
     å»ºç«‹å°ˆæ¡ˆ â†’ æ–°å¢ç¶²é æ‡‰ç”¨ç¨‹å¼ â†’ è¤‡è£½ firebaseConfig è²¼åœ¨é€™è£¡
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, set, get, onValue, runTransaction }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  /* â”€â”€ æŠŠä¸‹é¢é€™æ®µæ›æˆä½ è‡ªå·±çš„ firebaseConfig â”€â”€ */
  const firebaseConfig = {
    apiKey:            "AIzaSyCV-fEuYM0CjfdOwNfUOxpRBdfMJYmVKmE",
    authDomain:        "mahjong-37122.firebaseapp.com",
    databaseURL:       "https://mahjong-37122-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId:         "mahjong-37122",
    storageBucket:     "mahjong-37122.firebasestorage.app",
    messagingSenderId: "33619856179",
    appId:             "1:33619856179:web:e850ee56cce98c45cf8c46",
    measurementId:     "G-1VLL8PYSJS"
  };
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  window._db  = db;
  window._ref = ref;
  window._set = set;
  window._get = get;
  window._onValue = onValue;
  window._runTransaction = runTransaction;
  window._firebaseReady = true;
  document.dispatchEvent(new Event("firebase-ready"));
</script>

<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#0b1f14;--card:#162f20;--gold:#c39b3c;--gold-l:#e0bd6a;--gold-d:#8a6820;
  --ivory:#f0ead8;--ivory-m:rgba(240,234,216,.55);--red:#c0392b;--green:#27ae60;
  --border:rgba(195,155,60,.28);
}
html,body{height:100%;overflow-x:hidden;font-family:'Noto Serif TC',serif;
  background:var(--bg);color:var(--ivory);touch-action:manipulation}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:repeating-linear-gradient(60deg,transparent,transparent 3px,
    rgba(255,255,255,.012) 3px,rgba(255,255,255,.012) 6px)}

/* â”€â”€ screens â”€â”€ */
.screen{position:fixed;inset:0;overflow-y:auto;z-index:1;display:none;flex-direction:column}
.screen.on{display:flex}

/* â”€â”€ common â”€â”€ */
.wrap{max-width:480px;margin:0 auto;padding:0 18px;width:100%}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;
  padding:18px;margin-bottom:14px;
  box-shadow:0 4px 20px rgba(0,0,0,.35),inset 0 1px 0 rgba(195,155,60,.12)}
.stitle{font-size:.7rem;letter-spacing:.25em;color:var(--gold);text-transform:uppercase;
  margin-bottom:13px;display:flex;align-items:center;gap:8px}
.stitle::after{content:'';flex:1;height:1px;background:linear-gradient(to right,rgba(195,155,60,.35),transparent)}
.lbl{font-size:.72rem;color:var(--ivory-m);letter-spacing:.06em;margin-bottom:4px;display:block}
input,select{background:rgba(0,0,0,.35);border:1px solid rgba(195,155,60,.22);border-radius:9px;
  padding:12px 14px;color:var(--ivory);font-family:inherit;font-size:1rem;width:100%;
  outline:none;-webkit-appearance:none;transition:border-color .2s}
input:focus,select:focus{border-color:var(--gold)}
input::placeholder{color:rgba(240,234,216,.25)}
select{background:#0f2318}
select option{background:#0f2318}
.row{display:flex;gap:10px;align-items:flex-end}
.col{display:flex;flex-direction:column;flex:1}
.btn{border:none;border-radius:10px;padding:13px 20px;font-family:inherit;font-size:1rem;
  font-weight:700;cursor:pointer;width:100%;letter-spacing:.05em;
  transition:transform .1s,opacity .1s;touch-action:manipulation}
.btn:active{transform:scale(.97)}
.btn:disabled{opacity:.45;pointer-events:none}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold-d));color:var(--bg);
  box-shadow:0 3px 14px rgba(195,155,60,.38)}
.btn-red{background:linear-gradient(135deg,#c0392b,#7b241c);color:#fff;
  box-shadow:0 3px 10px rgba(192,57,43,.4)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--gold);padding:11px}
.btn-sm{padding:9px 14px;font-size:.85rem;border-radius:8px;width:auto}
.badge{font-size:.58rem;background:var(--gold);color:var(--bg);
  padding:2px 6px;border-radius:4px;font-weight:800}
.me-badge{font-size:.58rem;background:rgba(195,155,60,.2);color:var(--gold-l);
  padding:2px 6px;border-radius:4px;border:1px solid rgba(195,155,60,.45)}

/* name grid */
.name-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}

/* toggle */
.trow{display:flex;align-items:center;gap:10px}
.tbox{position:relative;width:46px;height:26px;flex-shrink:0}
.tbox input{opacity:0;width:0;height:0;position:absolute}
.tslider{position:absolute;inset:0;background:rgba(0,0,0,.4);
  border:1px solid rgba(195,155,60,.3);border-radius:26px;cursor:pointer;transition:.25s}
.tslider::before{content:'';position:absolute;width:20px;height:20px;
  background:rgba(240,234,216,.45);border-radius:50%;top:2px;left:2px;transition:.25s}
.tbox input:checked+.tslider{background:rgba(195,155,60,.28);border-color:var(--gold)}
.tbox input:checked+.tslider::before{transform:translateX(20px);background:var(--gold)}

/* â”€â”€ SETUP screen â”€â”€ */
#setup{padding-bottom:40px}
.big-title{text-align:center;padding:32px 0 20px}
.big-title h1{font-size:clamp(1.8rem,8vw,2.8rem);font-weight:900;color:var(--gold);
  text-shadow:0 2px 14px rgba(195,155,60,.4);letter-spacing:.08em}
.big-title p{font-size:.68rem;letter-spacing:.3em;color:var(--ivory-m);margin-top:5px}

/* Firebase config notice */
.notice{background:rgba(192,57,43,.15);border:1px solid rgba(192,57,43,.4);
  border-radius:10px;padding:14px 16px;margin-bottom:14px;font-size:.8rem;
  color:rgba(240,200,190,.85);line-height:1.6}
.notice strong{color:#e8967a}
.notice a{color:var(--gold-l)}

/* room code input */
.room-display{font-family:'Oswald',sans-serif;font-size:2rem;font-weight:700;
  color:var(--gold);letter-spacing:.2em;text-align:center;padding:10px 0}

/* â”€â”€ WHO screen â”€â”€ */
#who{align-items:center;justify-content:flex-start;padding-bottom:40px}
.who-title{text-align:center;padding:28px 0 18px}
.who-title h2{font-size:1.4rem;color:var(--gold);font-weight:900}
.who-title p{font-size:.75rem;color:var(--ivory-m);margin-top:4px}
.seat-btn{display:flex;align-items:center;gap:14px;
  background:rgba(0,0,0,.25);border:1px solid rgba(195,155,60,.2);border-radius:13px;
  padding:16px 18px;margin-bottom:12px;cursor:pointer;width:100%;
  font-family:inherit;color:var(--ivory);touch-action:manipulation;transition:.15s}
.seat-btn:active{transform:scale(.98)}
.seat-btn.east-seat{border-color:rgba(195,155,60,.5);background:rgba(195,155,60,.1)}
.seat-icon{width:46px;height:46px;border-radius:50%;background:rgba(195,155,60,.12);
  border:1px solid rgba(195,155,60,.3);display:flex;align-items:center;
  justify-content:center;font-size:1.4rem;flex-shrink:0}
.seat-name{font-size:1.05rem;font-weight:600;color:var(--gold-l)}
.seat-chips{font-size:.75rem;color:var(--ivory-m);margin-top:2px}

/* â”€â”€ GAME screen â”€â”€ */
#game{flex-direction:column}
.g-header{background:linear-gradient(to bottom,rgba(22,47,32,.99),rgba(11,31,20,.99));
  border-bottom:1px solid rgba(195,155,60,.2);padding:14px 18px;
  position:sticky;top:0;z-index:50;
  display:flex;align-items:center;justify-content:space-between}
.gh-name{font-size:1rem;font-weight:700;color:var(--gold-l);display:flex;align-items:center;gap:6px}
.gh-tiny{font-size:.6rem;letter-spacing:.12em;color:var(--ivory-m)}
.gh-chips{font-family:'Oswald',sans-serif;font-size:1.8rem;font-weight:700;line-height:1;text-align:right}

.tabs{display:flex;background:rgba(0,0,0,.3);border-bottom:1px solid rgba(195,155,60,.15);
  overflow-x:auto;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{flex:1;padding:11px 6px;background:transparent;border:none;
  border-bottom:2px solid transparent;color:var(--ivory-m);font-family:inherit;
  font-size:.73rem;cursor:pointer;white-space:nowrap;transition:.2s;touch-action:manipulation}
.tab.on{border-bottom-color:var(--gold);color:var(--gold)}

.g-body{flex:1;overflow-y:auto;padding:14px 18px 60px}
.g-body-inner{max-width:480px;margin:0 auto}

/* player overview cards */
.pc{background:rgba(0,0,0,.22);border:1px solid rgba(195,155,60,.16);
  border-radius:11px;padding:13px 15px;margin-bottom:10px;
  display:flex;align-items:center;justify-content:space-between}
.pc.me{border-color:rgba(195,155,60,.6);background:linear-gradient(145deg,rgba(195,155,60,.1),rgba(0,0,0,.3))}
.pc.east{border-color:rgba(195,155,60,.45);background:rgba(195,155,60,.08)}
.pc-left{display:flex;align-items:center;gap:10px}
.pc-ico{font-size:1.4rem}
.pc-name{font-size:.95rem;font-weight:600;color:var(--gold-l);display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.pc-diff{font-size:.67rem;color:var(--ivory-m);margin-top:2px}
.pc-amount{font-family:'Oswald',sans-serif;font-size:1.7rem;font-weight:700}

/* quick amount buttons */
.quick-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.qbtn{background:rgba(195,155,60,.1);border:1px solid rgba(195,155,60,.3);
  border-radius:8px;padding:8px 16px;color:var(--gold-l);font-family:inherit;
  font-size:.88rem;cursor:pointer;touch-action:manipulation}
.qbtn:active{background:rgba(195,155,60,.22)}

/* history */
.hist-item{padding:7px 0;border-bottom:1px solid rgba(255,255,255,.05);
  font-size:.78rem;color:var(--ivory-m);display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
.hist-amt{font-family:'Oswald',sans-serif;color:var(--gold);flex-shrink:0}
.hist-time{font-size:.65rem;color:rgba(240,234,216,.3)}

/* balance indicator */
.bal{text-align:center;font-size:.72rem;margin:4px 0 12px;padding:6px;border-radius:7px}
.bal.ok{color:rgba(39,174,96,.8);background:rgba(39,174,96,.07)}
.bal.bad{color:var(--red);background:rgba(192,57,43,.08)}

/* sync pulse */
.sync-dot{width:7px;height:7px;border-radius:50%;background:var(--green);
  display:inline-block;margin-right:5px;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.sync-off{background:var(--red);animation:none}

/* toast */
#toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(10px);
  background:rgba(11,31,20,.97);border:1px solid rgba(195,155,60,.45);
  color:var(--ivory);padding:10px 24px;border-radius:10px;font-size:.82rem;
  z-index:300;white-space:nowrap;pointer-events:none;
  opacity:0;transition:opacity .25s,transform .25s}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* modal */
#modal{position:fixed;inset:0;background:rgba(0,0,0,.78);
  display:flex;align-items:center;justify-content:center;z-index:200;display:none}
#modal.on{display:flex}
.modal-box{background:linear-gradient(145deg,#162f20,#0b1f14);
  border:1px solid var(--gold);border-radius:16px;padding:28px;
  max-width:320px;width:90%;text-align:center}
.modal-box h3{font-size:1.1rem;color:var(--gold);margin-bottom:10px}
.modal-box p{color:var(--ivory-m);font-size:.85rem;margin-bottom:20px;line-height:1.6}
.modal-btns{display:flex;gap:12px;justify-content:center}
.modal-btns .btn{width:auto;padding:10px 22px}

/* QR / room join section */
.room-join{display:flex;gap:10px;margin-bottom:12px}
.room-join input{font-family:'Oswald',sans-serif;font-size:1.1rem;letter-spacing:.15em;text-align:center;text-transform:uppercase}

/* tile deco */
.deco{text-align:center;color:rgba(195,155,60,.15);font-size:1.2rem;letter-spacing:.5rem;padding:8px 0}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 1 â€” é–‹å±€ / åŠ å…¥
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="setup" class="screen on">
  <div class="wrap">
    <div class="big-title">
      <h1>ğŸ€„ éº»å°‡ç±Œç¢¼</h1>
      <p>MAHJONG CHIP TRACKER</p>
    </div>

    <!-- Firebase æœªè¨­å®šè­¦å‘Š -->
    <div class="notice" id="fbNotice">
      âš ï¸ <strong>ä½¿ç”¨å‰è«‹å…ˆè¨­å®š Firebase</strong><br>
      1. å‰å¾€ <a href="https://console.firebase.google.com" target="_blank">console.firebase.google.com</a><br>
      2. å»ºç«‹å°ˆæ¡ˆ â†’ å·¦å´é¸ Realtime Database â†’ å»ºç«‹è³‡æ–™åº«ï¼ˆæ¸¬è©¦æ¨¡å¼ï¼‰<br>
      3. å›åˆ°å°ˆæ¡ˆç¸½è¦½ â†’ æ–°å¢ç¶²é æ‡‰ç”¨ç¨‹å¼ â†’ è¤‡è£½ <code>firebaseConfig</code><br>
      4. è²¼åˆ°æœ¬æª”æ¡ˆé ‚éƒ¨çš„ <code>firebaseConfig</code> å€æ®µï¼Œå­˜æª”å¾Œä¸Šå‚³åˆ°ä»»ä½•éœæ…‹ç¶²é ç©ºé–“å³å¯
    </div>

    <!-- å»ºç«‹æ–°æˆ¿é–“ -->
    <div class="card">
      <div class="stitle">ğŸ° å»ºç«‹æ–°æˆ¿é–“ï¼ˆèŠå®¶æ“ä½œï¼‰</div>
      <div style="margin-bottom:12px">
        <label class="lbl">æ¯äººåˆå§‹ç±Œç¢¼</label>
        <input type="number" id="initChips" value="1000" min="0" step="100" inputmode="numeric">
      </div>
      <div class="name-grid">
        <div><label class="lbl">ç©å®¶ä¸€</label><input id="n0" value="ç©å®¶ä¸€"></div>
        <div><label class="lbl">ç©å®¶äºŒ</label><input id="n1" value="ç©å®¶äºŒ"></div>
        <div><label class="lbl">ç©å®¶ä¸‰</label><input id="n2" value="ç©å®¶ä¸‰"></div>
        <div><label class="lbl">ç©å®¶å››</label><input id="n3" value="ç©å®¶å››"></div>
      </div>
      <div class="trow" style="margin-bottom:12px">
        <label class="tbox"><input type="checkbox" id="eastOn"><span class="tslider"></span></label>
        <span style="font-size:.88rem;color:var(--gold)">å•Ÿç”¨æ±å®¶ï¼ˆç¬¬äº”ä½ï¼‰</span>
      </div>
      <div id="eastNameWrap" style="display:none;margin-bottom:12px">
        <label class="lbl">æ±å®¶åç¨±</label>
        <input id="eastName" value="æ±å®¶">
      </div>
      <button class="btn btn-gold" id="createBtn" onclick="createRoom()">âœ¦ å»ºç«‹æˆ¿é–“</button>
    </div>

    <!-- åŠ å…¥å·²æœ‰æˆ¿é–“ -->
    <div class="card">
      <div class="stitle">ğŸ“± åŠ å…¥ç¾æœ‰æˆ¿é–“</div>
      <p style="font-size:.8rem;color:var(--ivory-m);margin-bottom:12px">è¼¸å…¥èŠå®¶åˆ†äº«çš„ 4 ä½æˆ¿é–“ä»£ç¢¼</p>
      <div class="room-join">
        <input id="joinCode" placeholder="ä¾‹ï¼šA3F7" maxlength="4" style="text-transform:uppercase">
        <button class="btn btn-outline btn-sm" style="width:auto;white-space:nowrap" onclick="joinRoom()">åŠ å…¥ â†’</button>
      </div>
    </div>

    <div class="deco">ğŸ€‡ ğŸ€ˆ ğŸ€‰ ğŸ€Š ğŸ€‹</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 2 â€” é¸åº§ä½
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="who" class="screen">
  <div class="wrap">
    <div class="who-title">
      <h2>é¸æ“‡ä½ çš„åº§ä½</h2>
      <p id="whoRoomCode" style="color:var(--gold);font-family:'Oswald',sans-serif;letter-spacing:.2em;font-size:1rem"></p>
    </div>
    <div id="seatList"></div>
    <button class="btn btn-outline" style="margin-top:4px;font-size:.85rem" onclick="showScreen('setup')">â† è¿”å›</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 3 â€” éŠæˆ²ä¸»ç•«é¢
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="game" class="screen">

  <!-- å›ºå®šé ‚éƒ¨ -->
  <div class="g-header">
    <div>
      <div class="gh-tiny"><span class="sync-dot" id="syncDot"></span>æˆ¿é–“ <span id="hRoomCode" style="font-family:'Oswald',sans-serif;letter-spacing:.12em"></span></div>
      <div class="gh-name" id="hName"></div>
    </div>
    <div>
      <div class="gh-chips" id="hChips"></div>
      <div class="gh-tiny" style="text-align:right">ç±Œç¢¼</div>
    </div>
  </div>

  <!-- Tab Bar -->
  <div class="tabs" id="tabBar"></div>

  <!-- Body -->
  <div class="g-body">
    <div class="g-body-inner" id="gameBody"></div>
  </div>
</div>

<!-- Modal -->
<div id="modal">
  <div class="modal-box">
    <h3 id="mTitle"></h3>
    <p id="mMsg"></p>
    <div class="modal-btns">
      <button class="btn btn-red btn-sm" id="mConfirm">ç¢ºèª</button>
      <button class="btn btn-outline btn-sm" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- Disconnected Bar -->
<div id="connBar" style="display:none;position:fixed;top:0;left:0;right:0;z-index:150;
  background:rgba(192,57,43,0.95);padding:10px 16px;
  align-items:center;justify-content:space-between;gap:10px;
  font-family:'Noto Serif TC',serif;font-size:0.8rem;color:#fff;border-bottom:1px solid #e74c3c;">
  <span>âš  é€£ç·šä¸­æ–·ï¼Œæ­£åœ¨é‡æ–°é€£ç·šâ€¦</span>
  <button onclick="if(G.roomCode&&G.myIdx!==null){subscribeRoom();updateConnStatus(true);}"
    style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.4);
    border-radius:6px;padding:4px 12px;color:#fff;font-family:inherit;cursor:pointer;font-size:0.75rem;">
    æ‰‹å‹•é‡é€£
  </button>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let G = {
  roomCode: null,
  myIdx: null,      // 0-3 or 'east'
  room: null,
  unsubscribe: null,
  currentTab: 'board',
};

// â”€â”€ Wait for Firebase
function waitFirebase(cb) {
  if (window._firebaseReady) return cb();
  document.addEventListener('firebase-ready', cb, { once: true });
}

// â”€â”€ Random 4-char room code
function genCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({length:4}, ()=>chars[Math.floor(Math.random()*chars.length)]).join('');
}

// â”€â”€ Screens
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('on'));
  document.getElementById(id).classList.add('on');
  window.scrollTo(0,0);
}

// â”€â”€ Toast
let toastTimer;
function toast(msg, dur=2500) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>el.classList.remove('show'), dur);
}

// â”€â”€ Modal
let modalCb;
function showModal(title, msg, cb) {
  document.getElementById('mTitle').textContent = title;
  document.getElementById('mMsg').textContent = msg;
  document.getElementById('mConfirm').onclick = ()=>{ closeModal(); cb(); };
  document.getElementById('modal').classList.add('on');
}
function closeModal() {
  document.getElementById('modal').classList.remove('on');
  document.getElementById('mConfirm').textContent = 'ç¢ºèª';
}
document.getElementById('modal').addEventListener('click', e=>{ if(e.target===e.currentTarget) closeModal(); });

// â”€â”€ Toggle east name field
document.getElementById('eastOn').addEventListener('change', function() {
  document.getElementById('eastNameWrap').style.display = this.checked ? 'block' : 'none';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function roomRef(code) { return window._ref(window._db, 'rooms/' + code); }

function tsNow() {
  return new Date().toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CREATE ROOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function createRoom() {
  if (!window._firebaseReady) return toast('âš  Firebase å°šæœªè¨­å®šï¼Œè«‹å…ˆå®Œæˆè¨­å®š');
  const btn = document.getElementById('createBtn');
  btn.disabled = true; btn.textContent = 'å»ºç«‹ä¸­â€¦';

  const init = parseInt(document.getElementById('initChips').value)||1000;
  const names = [0,1,2,3].map(i=>document.getElementById('n'+i).value.trim()||`ç©å®¶${i+1}`);
  const eastEnabled = document.getElementById('eastOn').checked;
  const eastName = document.getElementById('eastName').value.trim()||'æ±å®¶';
  const code = genCode();

  const room = {
    code, initChips:init,
    names, eastEnabled, eastName,
    chips: [init,init,init,init],
    eastChips: 0,
    history: [],
    createdAt: Date.now(),
  };

  try {
    await window._set(roomRef(code), room);
    G.roomCode = code;
    G.room = room;
    showWhoScreen(room);
    // Show code prominently
    toast(`âœ“ æˆ¿é–“å»ºç«‹ï¼ä»£ç¢¼ï¼š${code}`, 5000);
  } catch(e) {
    toast('âŒ å»ºç«‹å¤±æ•—ï¼š'+e.message);
  }
  btn.disabled=false; btn.textContent='âœ¦ å»ºç«‹æˆ¿é–“';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JOIN ROOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function joinRoom() {
  if (!window._firebaseReady) return toast('âš  Firebase å°šæœªè¨­å®š');
  const code = document.getElementById('joinCode').value.trim().toUpperCase();
  if (code.length !== 4) return toast('âš  è«‹è¼¸å…¥ 4 ä½æˆ¿é–“ä»£ç¢¼');

  try {
    const snap = await window._get(roomRef(code));
    if (!snap.exists()) return toast('âš  æ‰¾ä¸åˆ°æ­¤æˆ¿é–“');
    G.roomCode = code;
    G.room = snap.val();
    showWhoScreen(G.room);
  } catch(e) {
    toast('âŒ åŠ å…¥å¤±æ•—ï¼š'+e.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WHO SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showWhoScreen(room) {
  document.getElementById('whoRoomCode').textContent = 'æˆ¿é–“ï¼š' + room.code;
  const icons = ['ğŸ€€','ğŸ€','ğŸ€‚','ğŸ€ƒ']; // æ±å—è¥¿åŒ—
  const list = document.getElementById('seatList');
  list.innerHTML = '';

  room.names.forEach((name, i)=>{
    const btn = document.createElement('button');
    btn.className = 'seat-btn';
    btn.innerHTML = `
      <div class="seat-icon">${icons[i]}</div>
      <div>
        <div class="seat-name">${name}</div>
        <div class="seat-chips">ç±Œç¢¼ï¼š${Number(room.chips[i]).toLocaleString()}</div>
      </div>`;
    btn.onclick = ()=>askName(i, name);
    list.appendChild(btn);
  });

  if (room.eastEnabled) {
    const btn = document.createElement('button');
    btn.className = 'seat-btn east-seat';
    btn.innerHTML = `
      <div class="seat-icon">ğŸ®</div>
      <div>
        <div class="seat-name">${room.eastName} <span class="badge">æ±</span></div>
        <div class="seat-chips">ç®¡ç†ç±Œç¢¼çµç®—</div>
      </div>`;
    btn.onclick = ()=>enterGame('east');
    list.appendChild(btn);
  }

  showScreen('who');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ASK NAME before entering seat
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function askName(idx, currentName) {
  document.getElementById('mTitle').textContent = 'âœï¸ è¼¸å…¥ä½ çš„åå­—';
  document.getElementById('mMsg').innerHTML = `
    <input id="nameInput" value="${currentName}" placeholder="è¼¸å…¥åå­—"
      style="background:rgba(0,0,0,.35);border:1px solid rgba(195,155,60,.4);border-radius:9px;
      padding:11px 14px;color:#f0ead8;font-family:inherit;font-size:1rem;width:100%;
      outline:none;margin-top:4px;text-align:center;">
  `;
  document.getElementById('mConfirm').textContent = 'ç¢ºèªé€²å…¥';
  document.getElementById('mConfirm').onclick = async ()=>{
    const newName = document.getElementById('nameInput').value.trim() || currentName;
    closeModal();
    // Update name in Firebase and local state immediately
    if (newName !== currentName) {
      try {
        await window._runTransaction(roomRef(G.roomCode), current=>{
          if (!current) return;
          current.names[idx] = newName;
          return current;
        });
        // ç«‹å³æ›´æ–°æœ¬åœ° G.roomï¼Œç¢ºä¿é€²å…¥éŠæˆ²æ™‚åå­—æ­£ç¢ºé¡¯ç¤º
        if (G.room) G.room.names[idx] = newName;
      } catch(e) {}
    }
    enterGame(idx);
  };
  // Allow pressing Enter to confirm
  document.getElementById('modal').classList.add('on');
  setTimeout(()=>{
    const inp = document.getElementById('nameInput');
    if (inp) { inp.focus(); inp.select(); }
  }, 100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENTER GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function subscribeRoom() {
  if (G.unsubscribe) G.unsubscribe();
  G.unsubscribe = window._onValue(roomRef(G.roomCode), snap=>{
    if (!snap.exists()) return;
    G.room = snap.val();
    G.connected = true;
    updateConnStatus(true);
    renderGame();
  });
}

function enterGame(idx) {
  G.myIdx = idx;
  subscribeRoom();
  showScreen('game');
  renderTabs();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ICONS = ['ğŸ€€','ğŸ€','ğŸ€‚','ğŸ€ƒ']; // æ±å—è¥¿åŒ—

function myName() { return G.myIdx==='east' ? G.room.eastName : G.room.names[G.myIdx]; }
function myChips(){ return G.myIdx==='east' ? G.room.eastChips : G.room.chips[G.myIdx]; }
function isEast()  { return G.myIdx==='east'; }

function chipColor(c, init) {
  return c < 0 ? '#e74c3c' : c > init ? '#2ecc71' : 'var(--ivory)';
}

function renderGame() {
  if (!G.room) return;
  const r = G.room;
  const mc = myChips();
  const col = chipColor(mc, r.initChips);

  // Header
  document.getElementById('hRoomCode').textContent = r.code;
  document.getElementById('hName').innerHTML =
    myName() + (isEast() ? ' <span class="badge">æ±</span>' : ' <span class="me-badge">æˆ‘</span>');
  document.getElementById('hChips').style.color = col;
  document.getElementById('hChips').textContent = mc.toLocaleString();

  // Sync dot â€“ just always green if we're getting updates
  document.getElementById('syncDot').className = 'sync-dot';

  renderTabContent();
}

function renderTabs() {
  const tabs = [
    { id:'board',    label:'ğŸ“Š ç¸½è¦½' },
    ...(!isEast() ? [{ id:'transfer', label:'â†• è½‰ç§»' }] : []),
    { id:'history',  label:'ğŸ“œ ç´€éŒ„' },
  ];
  const bar = document.getElementById('tabBar');
  bar.innerHTML = tabs.map(t=>
    `<button class="tab${G.currentTab===t.id?' on':''}" onclick="switchTab('${t.id}')">${t.label}</button>`
  ).join('');
}

function switchTab(id) {
  G.currentTab = id;
  renderTabs();
  renderTabContent();
}

function renderTabContent() {
  const body = document.getElementById('gameBody');
  if (G.currentTab==='board')    body.innerHTML = renderBoard();
  if (G.currentTab==='transfer') body.innerHTML = renderTransfer();
  if (G.currentTab==='history')  body.innerHTML = renderHistory();
  renderTabs();
}

// â”€â”€ Board â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBoard() {
  const r = G.room;
  const total = r.chips.reduce((a,b)=>a+b,0) + r.eastChips;
  const expected = r.initChips * 4;
  const balanced = total === expected;

  let html = '';
  r.names.forEach((name,i)=>{
    const c = r.chips[i];
    const col = chipColor(c, r.initChips);
    const isSelf = !isEast() && i===G.myIdx;
    html += `<div class="pc${isSelf?' me':''}">
      <div class="pc-left">
        <div class="pc-ico">${ICONS[i]}</div>
        <div>
          <div class="pc-name">${name}${isSelf?'<span class="me-badge">æˆ‘</span>':''}</div>
          <div class="pc-diff">ç›¸è¼ƒåˆå§‹ ${fmtDiff(c-r.initChips)}</div>
        </div>
      </div>
      <div class="pc-amount" style="color:${col}">${c.toLocaleString()}</div>
    </div>`;
  });

  if (r.eastEnabled) {
    const c = r.eastChips;
    const isSelf = isEast();
    html += `<div class="pc east${isSelf?' me':''}">
      <div class="pc-left">
        <div class="pc-ico">ğŸ®</div>
        <div>
          <div class="pc-name">${r.eastName} <span class="badge">æ±</span>${isSelf?'<span class="me-badge">æˆ‘</span>':''}</div>
          <div class="pc-diff">ç±Œç¢¼æ”¶æ”¯</div>
        </div>
      </div>
      <div class="pc-amount" style="color:${chipColor(c,0)}">${c.toLocaleString()}</div>
    </div>`;
  }

  html += `<div class="bal ${balanced?'ok':'bad'}">
    ç¸½ç±Œç¢¼ ${total.toLocaleString()} ï¼ åˆå§‹ ${expected.toLocaleString()} ${balanced?'âœ“ å¹³è¡¡':'âš  ä¸å¹³è¡¡'}
  </div>`;

  html += `<button class="btn btn-red" style="margin-bottom:10px" onclick="confirmReset()">ğŸ”„ ä¸€éµæ­¸é›¶</button>`;
  html += `<button class="btn btn-outline" style="margin-bottom:10px" onclick="showWhoScreen(G.room)">â† åˆ‡æ›ç©å®¶</button>`;
  html += `<div class="deco">ğŸ€‡ ğŸ€ˆ ğŸ€‰ ğŸ€Š ğŸ€‹</div>`;
  return html;
}

// â”€â”€ Transfer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTransfer() {
  if (isEast()) return '<p style="color:var(--ivory-m);padding:20px 0;text-align:center">æ±å®¶ä¸éœ€è¦è½‰ç§»ç±Œç¢¼</p>';
  const r = G.room;
  let opts = r.names.map((n,i)=>i!==G.myIdx?`<option value="p${i}">${n}</option>`:'').join('');
  if (r.eastEnabled) opts += `<option value="east">ğŸ® ${r.eastName}ï¼ˆæ±å®¶ï¼‰</option>`;

  return `
    <div class="card">
      <div class="stitle">â†• è½‰ç§»ç±Œç¢¼</div>
      <div style="background:rgba(0,0,0,.2);border:1px solid rgba(195,155,60,.35);border-radius:8px;padding:11px 13px;margin-bottom:12px;color:var(--gold-l);font-weight:600">
        ${r.names[G.myIdx]} â€” æŒæœ‰ ${r.chips[G.myIdx].toLocaleString()} ç±Œç¢¼
      </div>
      <div style="margin-bottom:10px">
        <label class="lbl">è½‰çµ¦</label>
        <select id="toSel">${opts}</select>
      </div>
      <div style="margin-bottom:12px">
        <label class="lbl">ç±Œç¢¼æ•¸é‡</label>
        <input type="number" id="tAmt" placeholder="è¼¸å…¥é‡‘é¡" inputmode="numeric" min="1">
      </div>
      <div class="quick-row">
        ${[30,40,50,70,100].map(v=>`<button class="qbtn" onclick="document.getElementById('tAmt').value=${v}">${v}</button>`).join('')}
      </div>
      <button class="btn btn-gold" onclick="doTransfer()">ç¢ºèªè½‰ç§» â†’</button>
    </div>`;
}

// â”€â”€ East / Zimo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEast() {
  const r = G.room;
  if (!r.eastEnabled) return '';
  const opts = r.names.map((n,i)=>`<option value="${i}">${n} è‡ªæ‘¸</option>`).join('');

  return `
    <div class="card">
      <div class="stitle">ğŸ® è‡ªæ‘¸çµç®—</div>
      <p style="font-size:.78rem;color:var(--ivory-m);margin-bottom:14px;line-height:1.6">
        è‡ªæ‘¸æ™‚ï¼Œå…¶ä»–ä¸‰ä½ç©å®¶å„ä»˜ç±Œç¢¼çµ¦æ±å®¶<br>
        æ±å®¶ç›®å‰æ”¶å–ï¼š<strong style="color:var(--gold);font-family:'Oswald',sans-serif;font-size:1.1rem">${r.eastChips.toLocaleString()}</strong>
      </p>
      <div style="margin-bottom:10px">
        <label class="lbl">è‡ªæ‘¸ç©å®¶ï¼ˆå…¶ä»–ä¸‰äººä»˜çµ¦æ±å®¶ï¼‰</label>
        <select id="zimoSel">${opts}</select>
      </div>
      <div style="margin-bottom:12px">
        <label class="lbl">æ¯äººä»˜çµ¦æ±å®¶é‡‘é¡</label>
        <input type="number" id="zimoAmt" placeholder="è¼¸å…¥é‡‘é¡" inputmode="numeric" min="1">
      </div>
      <div class="quick-row">
        ${[50,100,200,500].map(v=>`<button class="qbtn" onclick="document.getElementById('zimoAmt').value=${v}">${v}</button>`).join('')}
      </div>
      <button class="btn btn-gold" onclick="doZimo()">ğŸ® å®Œæˆè‡ªæ‘¸çµç®—</button>
    </div>`;
}

// â”€â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHistory() {
  const hist = G.room.history || [];
  if (!hist.length) return `<div style="text-align:center;color:rgba(240,234,216,.3);padding:30px 0;font-size:.85rem">å°šç„¡äº¤æ˜“ç´€éŒ„</div>`;
  return hist.map(h=>`
    <div class="hist-item">
      <div>
        <span class="hist-time">${h.t} &nbsp;</span>${h.desc}
      </div>
      <div class="hist-amt">+${h.amt}</div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS (use runTransaction for safe concurrent writes)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtDiff(n) { return (n>=0?'+':'')+n.toLocaleString(); }

async function doTransfer() {
  const toVal = document.getElementById('toSel').value;
  const amt   = parseInt(document.getElementById('tAmt').value);
  const from  = G.myIdx;
  if (!amt||amt<=0) return toast('âš  è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡');
  const toEast = (toVal === 'east');
  const toIdx  = toEast ? null : parseInt(toVal.replace('p',''));

  const rr = roomRef(G.roomCode);
  try {
    await window._runTransaction(rr, current=>{
      if (!current) return;
      // å…è¨±è² å€¼ï¼Œä¸å†æª¢æŸ¥ç±Œç¢¼æ˜¯å¦è¶³å¤ 
      current.chips[from] -= amt;
      const toName = toEast ? current.eastName : current.names[toIdx];
      if (toEast) {
        current.eastChips += amt;
      } else {
        current.chips[toIdx] += amt;
      }
      if (!current.history) current.history=[];
      current.history.unshift({ t:tsNow(), desc:`${current.names[from]} â†’ ${toName}`, amt });
      if (current.history.length>60) current.history=current.history.slice(0,60);
      return current;
    });
    document.getElementById('tAmt').value='';
    toast('âœ“ è½‰ç§»æˆåŠŸ');
  } catch(e) { toast('âŒ å¤±æ•—ï¼š'+e.message); }
}

async function doZimo() {
  const winner = parseInt(document.getElementById('zimoSel').value);
  const amt    = parseInt(document.getElementById('zimoAmt').value);
  if (!amt||amt<=0) return toast('âš  è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡');

  const rr = roomRef(G.roomCode);
  try {
    await window._runTransaction(rr, current=>{
      if (!current) return;
      const payers = [0,1,2,3].filter(i=>i!==winner);
      for (const p of payers) {
        if (current.chips[p] < amt) { toast(`âš  ${current.names[p]} ç±Œç¢¼ä¸è¶³`); return; }
      }
      let total = 0;
      for (const p of payers) { current.chips[p]-=amt; total+=amt; }
      current.eastChips += total;
      if (!current.history) current.history=[];
      current.history.unshift({ t:tsNow(), desc:`è‡ªæ‘¸ï¼ˆ${current.names[winner]}ï¼‰ä¸‰å®¶å„ä»˜ ${amt} â†’ ${current.eastName}`, amt:total });
      if (current.history.length>60) current.history=current.history.slice(0,60);
      return current;
    });
    document.getElementById('zimoAmt').value='';
    toast(`âœ“ è‡ªæ‘¸çµç®—å®Œæˆ`);
  } catch(e) { toast('âŒ å¤±æ•—ï¼š'+e.message); }
}

function confirmReset() {
  showModal('âš  ç¢ºèªæ­¸é›¶', 'ç¢ºå®šå°‡æ‰€æœ‰ç±Œç¢¼é‡ç½®å›åˆå§‹å€¼ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚', doReset);
}

async function doReset() {
  const rr = roomRef(G.roomCode);
  try {
    await window._runTransaction(rr, current=>{
      if (!current) return;
      current.chips = current.chips.map(()=>current.initChips);
      current.eastChips = 0;
      current.history = [];
      return current;
    });
    toast('âœ“ å·²æ­¸é›¶');
  } catch(e) { toast('âŒ å¤±æ•—ï¼š'+e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONNECTION STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateConnStatus(online) {
  const dot = document.getElementById('syncDot');
  const bar = document.getElementById('connBar');
  if (!dot) return;
  dot.className = online ? 'sync-dot' : 'sync-dot sync-off';
  if (bar) bar.style.display = online ? 'none' : 'flex';
}

// â”€â”€ Reconnect when page becomes visible again (phone wake / app switch back)
document.addEventListener('visibilitychange', ()=>{
  if (document.visibilityState === 'visible' && G.roomCode && G.myIdx !== null) {
    subscribeRoom(); // re-attach listener
    updateConnStatus(true);
  }
});

// â”€â”€ Also reconnect on window focus (desktop fallback)
window.addEventListener('focus', ()=>{
  if (G.roomCode && G.myIdx !== null) subscribeRoom();
});

// â”€â”€ Detect offline / online
window.addEventListener('offline', ()=>updateConnStatus(false));
window.addEventListener('online', ()=>{
  if (G.roomCode && G.myIdx !== null) subscribeRoom();
  updateConnStatus(true);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD TO HOME SCREEN BANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showInstallBanner() {
  if (document.getElementById('installBanner')) return;
  // Only show if not already installed as PWA
  if (window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches) return;
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isAndroid = /android/i.test(navigator.userAgent);
  if (!isIOS && !isAndroid) return;

  const msg = isIOS
    ? 'ğŸ“² é»åº•éƒ¨ â–¡ åˆ†äº« â†’ åŠ å…¥ä¸»ç•«é¢ï¼Œé¿å…é é¢ä¸­æ–·'
    : 'ğŸ“² é»å³ä¸Šè§’é¸å–® â†’ æ–°å¢åˆ°ä¸»ç•«é¢ï¼Œé¿å…é é¢ä¸­æ–·';

  const banner = document.createElement('div');
  banner.id = 'installBanner';
  banner.style.cssText = `position:fixed;bottom:0;left:0;right:0;z-index:400;
    background:linear-gradient(135deg,#1a4a2a,#0d2d1a);
    border-top:1px solid rgba(195,155,60,0.5);
    padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;
    font-family:'Noto Serif TC',serif;font-size:0.78rem;color:#f0ead8;`;
  banner.innerHTML = `
    <span>${msg}</span>
    <button onclick="document.getElementById('installBanner').remove()"
      style="background:rgba(195,155,60,0.2);border:1px solid rgba(195,155,60,0.4);
      border-radius:6px;padding:5px 12px;color:#e0bd6a;font-family:inherit;
      font-size:0.75rem;cursor:pointer;white-space:nowrap;flex-shrink:0;">çŸ¥é“äº†</button>
  `;
  document.body.appendChild(banner);
}

// Show install banner 3 seconds after entering game
const _origEnterGame = enterGame;
// patch: show banner when game starts
setTimeout(()=>{ if(G.myIdx!==null) showInstallBanner(); }, 3000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Firebase config check
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
waitFirebase(()=>{
  // If user has filled real config, hide the notice
  const notice = document.getElementById('fbNotice');
  const url = document.querySelector('script[type=module]')?.textContent||'';
  if (!url.includes('YOUR_PROJECT')) notice.style.display='none';
});
</script>
</body>
</html>
